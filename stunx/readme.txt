Session Traversal Utilities for NAT
P2P互连NAT穿透协助工具。

仅定义和实现端点对自身NAT类型的侦测协助。与标准的STUN不同，这里服务器构成了一个P2P网络，故无需双ip。
参与组网的服务器仅限于公网可直接访问者，包括 Full Cone 类型和通过 UPnP 映射出来的开放端点。

因当前NAT部署中对TCP连接的配置较严（端口号无法固定），故此仅针对UDP连接穿透。
TCP的穿透仅采用TRUNS中继服务方式。

注：
应用层可通过自己实现来获得可靠的UDP传输，如 UDT 或 KCP 等。


名称简写
--------
	FullC   Full Cone 完全圆锥型，任意IP和Port（IP+, Port+）
	RC	Restricted Cone 受限圆锥型（=IP, Port+）
	P-RC	Port Restricted Cone 端口受限圆锥型（=IP, =Port）
	Sym	Symmetric NAT

可连接性
--------
	0. Pub/UPnP <- xx
	开放访问端，接受任意NAT类型端点连接。

	1. FullC <- xx
	类似第0类型，接受任意来源。知道IP和Port即可。

	2. RC <- xx
	向目标「IP + 任意Port」发送数据包后（打洞），接受任意来源。
	均衡资源利用，优先匹配Sym来源。

	3. P-RC <- xx（-Sym）
	向目标IP和所用Port发送数据包后，接受目标连接。
	仅支持同类以上（开放性），不适用Sym类型。

	4. Sym -> xx
	仅对外连接。可连接至 RC 以上开放型类型端。
	此类端点可执行对外连接测试，协助判断 FullC 类型（仅此贡献）。



指令集
===============================================================================

类型检测
--------
	1. STUN:Info
	获取本端外网信息，包含IP和端口。直接交互。
	这是基础信息，可决定后续侦测过程是否需要继续。
	注：
	- 如果两个服务端返回的值不同，则为Sym类型，无需进一步操作。
	- 考虑服务端的不诚实可能，可请求2个以上服务，综合评估。
	  如3个返回值中有2个相同，可视为相同。

	2. STUN:NewPort
	用一个新的端口发送信息包。信息包由客户端创建，包含识别ID。
	侦测客户端是RC或是P-RC类型：
	- 收到信息为RC类型
	- 未收到信息为P-RC类型
	注：
	服务端可能发送多个相同包，默认3个。

	3. STUN:NewHost
	对于RC类型，可进一步测试是否为FullC类型。
	用不同的主机发送信息包（同上），收到即为FullC，未收到则止于RC。
	注：
	- 新的主机通常选择连接池中的Sym或P-RC类型，已充分利用资源。
	- 服务端可能向多个主机发出协助请求，通常为2-3个。
	- 服务端会向客户端确认发送协助请求的数量（可能为0）。


打洞协作
--------
考虑最大化利用已有资源，应遵循如下连接优先级：
	1. Sym 	-> RC, FullC
	3. P-RC -> P-RC, RC, FullC
	2. RC 	-> P-RC, RC, FullC
	注：
	- 箭头为连接方向，打洞为反方向实施。
	- 同级之间为发起连接请求者打洞，对端连入。

在客户端已知自己NAT类型之后，根据以上优先级分配打洞和连入者（无需同时打洞）。


信息包
------
信息包用于双方的打洞/连接沟通，它由共同连接的服务端或通过P2P网络传递。
	1.
	公网地址（IP+Port）
	2.
	局端地址（IP+Port）
	客户端本地内网IP和端口，用于本地连接优化。
	3.
	标识ID（随机值）
	4字节毫秒时间段 + 4字节随机整数。
	用于本地同网判断：如果局端网络相同，尝试连接并请求标识ID然后对比。
	4.
	自身NAT类型
	用于决定谁打洞谁连入。



侦测流程
===============================================================================
	1. 
	客户端向A，B两个服务端发送STUN:Info请求，检查返回的两个值中端口是否相同。
	不同则为Sym类型，无需进一步努力。

	2.
	客户端向A和B服务端分别发送STUN:NewPort请求，侦测自己是否为RC类型。
	未收到回复则为P-RC，无需进一步询问。
	注：
	同时发起2个请求是一种可靠性措施，只要收到一个回复即可确认。

	3.
	若在第2步收到回应，则检测是否为FullC类型：
	客户端向A和B或新的服务端发送STUN:NewHost请求。若收到回应，且回应主机不在自身的连接池内，则为FullC类型。
	注：
	客户端应记忆已连接过的服务端，如果响应端是这些主机则无效。
