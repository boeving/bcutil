Session Traversal Utilities for NAT
P2P互连穿透服务。

与标准STUN稍有不同，仅支持单ip。
与另一个stun-serv协作完成来源NAT端口侦测（Full Cone）。


名称简写
--------
	FullC   Full Cone 完全圆锥型，任意IP和Port（IP+, Port+）
	RC	Restricted Cone 受限圆锥型（=IP, Port+）
	P-RC	Port Restricted Cone 端口受限圆锥型（=IP, =Port）
	Sym	Symmetric NAT

可连接性
--------
	1. FullC <- xx
	接受任意来源，类似公网端。知道IP和Port即可等同公网端。
	注：数量极少。

	2. RC（+IP） <- xx
	向目标IP发送数据包（打洞）后，接受目标IP来源。适用Sym来源。

	3. P-RC（+IP, +Port） <- xx（-Sym）
	向目标IP和Port发送数据包后，接受目标准确来源。因此对Sym无效。
	注：
	暂不考虑对Sym端预测性端口打洞。

	4. Sym -> xx
	仅对外连接。可连接至 FullC，RC（预打洞）类型端。
	这样的端点无法成为服务网络里的主机，通常是应用级启动的外联信息收集端。



指令集
===============================================================================

类型检测
--------
	1. STUN:Owner
	本端外网信息，包含IP和端口。由原连接返回客户端。

	2. STUN:NewPort(count)
	用一个新的端口返回信息。
	信息包由客户端创建，包含识别ID。用于侦测客户端是RC还是P-RC类型：
	- 收到为RC类型
	- 未收到为P-RC类型
	注：
	count为请求尝试的次数（UDP方式，通常2-8次），服务端酌情处理。

	3. STUN:NewHost(count)
	用一个新的主机发送信息，侦测客户端是否为FullC类型（收到即是）。
	信息包同上。
	新的主机任意选择，服务端通常选择连接池中的P-RC类型来用（开放服务能力最弱）。
	注：
	通常不选择FullC，一是浪费资源，二也避免碰巧选到曾与客户端连接过的服务器。


连接协助
--------
	由客户端向服务端发起请求。
	客户端可以是普通的应用端，也可能是请求联网的同类服务器。

	服务端根据客户端和目标主机的NAT类型，按资源平衡的原则配对打洞指令。
	优先级：
	1. Sym 	-> RC	// Sym只能向外连接至RC以上（开放性）
	2. RC 	-> P-RC	// P-RC不能接收Sym的连接，因此接收RC连入平衡进出
	3. P-RC -> P-RC // 同类之间发起者打洞，请求对端连接
	4. RC   -> RC 	// 同上
	注：
	FullC 划归服务端，不参与打洞互连。仅接受连接提供服务（不连出）。

	1. STUN:TCP(count2, addr...)
	请求协助目标地址集的TCP连接。

	2. STUN:UDP(count2, addr...)
	请求协助目标地址集的UDP连接。

	Addr格式
	- IPv6: IP[16]Zone[2]Port[2]ID[8] => 28字节
	- IPv4: IP[4]Port[2]ID[8] => 14字节
	addr...
	表示两种地址的串连序列，IPv4在前，IPv6在后。

	count2
	明确addr...的地址分配。2字节：
	- 1[1+7] 计数IPv4地址数。仅用低7位，最多支持0x7f个地址。
	- 2[+8]  计数IPv6地址数（最多0xff）。如前字节最高位为1，则合并计数（全为IPv6，最多0x7fff个）。


打洞指令
--------
	由服务端向已连接的客户端发出打洞指令。
	打洞逻辑（单向）：
	TCP：
	- 接受连接端先向连出端发送1-2个连接请求（打洞），停止后（肯定失败）随即启动监听。
	- 连出端不断尝试对外连接（无监听）。当接收端打洞成功后，连接成功。
	UDP：
	- 类似TCP，但接收端打洞尝试次数稍多，且无监听逻辑。

	1. Conn:TCP(IN, addr)
	TCP连接接收端。用TCP协议向目标地址发起打洞连接，然后监听。
	注：无需SO_REUSEADDR选项。

	2. Conn:TCP(OUT, addr)
	TCP连接发起端。用TCP协议向目标地址持续发起连接请求，直至连接成功（或超时）。

	3. Conn:UDP(IN, addr)
	UDP连接接受端。也为打洞方。特定次数打洞请求。

	4. Conn:UDP(OUT, addr)
	UDP连接发起端。多次持续尝试直至连接成功或主动放弃。


信息包
------
	1. 开放地址
	   最后NAT映射的公网IP和端口。

	2. 局端地址
	   客户端本地内网IP和端口。
	   可能包含第二组本地家庭网关所在外网的IP地址和端口（注：可通过UPnP方式获取）。

	3. 随机标识ID。4字节毫秒时间段 + 4字节随机整数。
	   连接尝试：
	   如果局端地址与本地网络相同，尝试连接并请求标识ID。
	   真同网则可成功，否则肯定失败。

	4. 打洞指令....



侦测流程
===============================================================================
	1. 
	客户端向A，B两个服务端发送STUN:Owner侦测请求，检查返回的两个值中端口是否相同。
	不同则为Sym类型，无需进一步努力。
	注：
	此时获得两个会提供服务的服务端。

	2.
	客户端向A和B服务端分别发送STUN:NewPort请求，侦测自己是否为RC或FullC类型。
	未收到回复则为P-RC类型，无需进一步询问（是否更好）。
	注：
	同时向两个服务端发起请求是一种可靠性措施，避免服务端的惰性（未响应该请求）。
	只要收到一个回复即可确认为非P-RC。

	3.
	若在第2步收到回应，则检测是否更开放（为FullC类型）：
	客户端向A/B或新的服务端发送STUN:NewHost请求。若收到回应，则为FullC类型，否则为RC类型。
	注：
	为了提高可靠性，可以同时向更多个服务端发起该请求。只要有一个成功即可。
	注意，客户端应记忆已连接过的服务端，如果响应端是这些主机则无效。
