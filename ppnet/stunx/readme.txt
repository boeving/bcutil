Session Traversal Utilities for NAT
P2P互连NAT穿透协助工具。

仅定义和实现端点对自身NAT类型的侦测协助。与标准的STUN不同，这里服务器构成了一个P2P网络，故无需双ip。
参与组网的服务器仅限于公网可直接访问者，包括 Full Cone 类型和通过 UPnP 映射出来的开放端点。

因当前NAT部署中对TCP连接的配置较严（端口号无法固定），故此仅针对UDP连接穿透。
TCP的穿透仅采用TRUNS中继服务方式。

注：
应用层可通过自己实现来获得可靠的UDP传输，如 UDT 或 KCP 等。


名称简写
--------
	Pub 	Public 开放公共域（端口可控）
	FullC   Full Cone 完全圆锥型，任意IP和Port
	RC	Restricted Cone 受限圆锥型（IP相同, Port任意）
	P-RC	Port Restricted Cone 端口受限圆锥型（IP/Port都相同）
	Sym	Symmetric NAT 对称型


可连接性
--------
原则上，第0/1类型提供公共域服务，不参与打洞互连。

	0. Pub/UPnP <- xx
	开放访问端，接受任意NAT类型端点连接。

	1. FullC <- xx
	类似第0类型，接受任意来源。知道IP和Port即可。

	2. RC <- xx
	向目标「IP + 任意Port」发送数据包后（打洞），接受任意来源。
	均衡资源利用，优先匹配Sym来源。

	3. P-RC <- xx（-Sym）
	向目标IP和所用Port发送数据包后，接受目标连接。
	仅支持同类以上（开放性），不适用Sym类型。

	4. Sym -> xx
	仅对外连接。可连接至 RC 以上开放类型端。
	此类端点可执行对外连接测试，协助判断 FullC 类型（仅此贡献）。


类型检测
--------
以下每步都为独立行为，不要求服务端持续服务。
检测指令共3个，有序进行。

	1. STUN:Info
	获取本端外网信息，包含IP和端口。
	这是最基础的信息，会决定后续检测过程是否有必要继续。

	向两个服务端发送该请求，根据回应判断：
	- 如果无返回信息，表示UDP协议被路由屏蔽。结束。
	- 如果两个服务端返回的值不同，则为Sym类型。结束。
	  注：考虑P2P网络特性，可请求2个以上服务评估。如3个返回中2个相同可视为相同。
	- 如返回值相同且端口号与本地设置（或UPnP映射）相同，则很可能为Pub。
	  标记并跳到第3步（优化），否则进入下一步检测。

	2. STUN:NewPort
	该步检测客户端是P-RC或RC以上类型。
	请求服务端用一个新的端口发送信息包。信息包由客户端创建，包含识别ID。
	- 未收到信息为P-RC类型。
	- 收到信息为RC或FullC或Pub类型。
	注：
	- 服务端可能发送多个相同包，默认3个。
	- 可能向第1步的2个服务端同时发送请求以提高可靠性。

	3. STUN:NewHost
	此步侦测是否为FullC以上类型。
	请求服务端联系不同的主机发送信息包，收到则为FullC或Pub。
	否则：
	- 如果由第1步跳过来，则返回执行第2步测试。
	- 如果由第2步顺序执行至此，则结束，止于RC。
	注：
	- 新的主机通常选择连接池中的Sym或P-RC类型，已充分利用资源。
	- 服务端可能向多个主机发出协助请求，通常为2-3个。
	- 服务端会向客户端确认发送的协助请求数量，0表示无法协助。
	- 客户端应记忆已连接过的服务端，如果消息来自这些主机则无效。

	4. Pub 核实
	此步可选。因与FullC同等对待故无关紧要。
	如步骤1中已标记，则向不同的服务端发送 STUN:Info 请求，检查返回地址中的端口值，
	如与本地设置/UPnP映射相同，则大概率确认为Pub类型。

	此步可延后测试，如在2小时之后的第二轮检测中首先进行。
	注：端点对自身NAT类型每隔2小时重新检测一次。


打洞协作
--------
考虑最大化利用已有资源，应遵循如下连接优先级：
	1. Sym 	-> RC, FullC
	3. P-RC -> P-RC, RC, FullC
	2. RC 	-> P-RC, RC, FullC

箭头为连接方向，打洞为反方向实施。
同级之间为发起者打洞，对端连入。否则按连接方向请求对端打洞，自己连入。


信息包
------
信息包用于双方的打洞/连接沟通，它由共同连接的服务端或P2P网络传递。
	- 请求类型：
	  1. 请求打洞；
	  2. 请求连入；
	- 自身公网地址（IP + Port）
	- 局端本地地址（IP/Mask + Port）。用于本地连接优化。
	- 标识ID（随机值）。
	  4字节微秒时间段 + 4字节随机整数。拨号联系时的身份辨识值。
